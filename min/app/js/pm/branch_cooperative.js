$(function(){var o=commonTools._dataCookies(commonTools.storage.main)||{},t=!0,a=document.referrer;-1==a.indexOf("branch-info")&&-1==a.indexOf("shopdata-comment")&&-1==a.indexOf("shopcoupon-list")&&Cookies.remove("offset"),commonTools._dataStorage(commonTools.storage.listtype,listtype),commonTools._dataStorage(commonTools.storage.cate,cate),commonTools._dataStorage("page_from",null),Cookies.get("app_version")?webview.getLocation():ipLocation(),$(".subnavbar .blog-cate a").each(function(){$(this).data("cate")==$(".branch-list-container").data("cate")&&$(this).addClass("active")}),$(".goToBranch").on("click",function(){$(".goToBranch").unbind("click"),showIndicator(),Cookies.remove("offset");var o=$(this).parents(".start_id"),t=o.data("id"),a={top:o.position().top,href:location.href,leng:o.index()+1,amount:20*Math.ceil((o.index()+1)/20)};Cookies.set("offset",JSON.stringify(a)),location.href="/pm/branch-info?sd_id="+t}),$(".swiper_num").on("click",function(){commonTools._dataStorage(commonTools.storage.cate,$(this).data("cate"))}),$(".advanced_search").on("click",function(){var o={spm_serno:1,sd_shopname:"",sd_lat:"",sd_lng:"",sd_country:""};commonTools._dataStorage(commonTools.storage.search_result,o),window.location.href="/Shop#!/shop-search-result"}),$(".btn_favorite").on("click",function(){o.sat?window.location.href="/Shop#!/shop/favorite":commonTools.setPopBox({title:stringObj.text.warn,text:stringObj.text.notLogin,buttons:[{text:stringObj.text.cancel,onClick:function(){removeSomething()}},{text:stringObj.text.login,onClick:function(){removeSomething(),webview.loginPage()}}]})}),$("#btn_openstore").on("click",function(){o.sat?window.location.href="/Shop#!/application-shop":commonTools.setPopBox({title:stringObj.text.warn,text:stringObj.text.notLogin,buttons:[{text:stringObj.text.cancel,onClick:function(){removeSomething()}},{text:stringObj.text.login,onClick:function(){removeSomething(),webview.loginPage()}}]}),closeLeftPopup(),$(".views").removeClass("blur")}),$(".left .open-popup").on("click",function(){$(".popup.shop-menu").addClass("modal-in"),$(".views").addClass("blur"),$("body").append('<div class="popup-overlay modal-overlay-visible"></div>'),$(document).mouseup(function(o){var t=$(".popup.shop-menu");t.is(o.target)||0!==t.has(o.target).length||(closeLeftPopup(),$(".views").removeClass("blur"))})}),$(".btn_map").on("click",function(){window.location.href="/Shop#!/map"}),$(".close-btn .close-popup").on("click",function(){closeLeftPopup(),$(".views").removeClass("blur")}),$(".around_search").unbind("click"),$(".around_search").on("click",function(){commonTools._dataStorage(commonTools.storage.search_result,null),commonTools._dataStorage("page_from","around_search");var o={};void 0!==Cookies.get("app_version")?webview.getLocation():$.getJSON("http://ip-api.com/json/?callback=?",function(t){o.spm_serno=2,o.sd_lat=t.lat||"",o.sd_lng=t.lon||"",o.sd_shopname="",o.sd_country="",commonTools._dataStorage(commonTools.storage.search_result,o),window.location.href="/Shop#!/around-search-result?from=around_search"})}),window.onload=function(){setHotKey(),setFavoriteImage(),swiper(),Lazy(),$(window).width()>=992&&setScrollBar()},$(window).resize(function(){browser_width=$(window).width(),browser_height=$(window).height(),browser_width<992?($(".draggable-box").css("width",browser_width),$(".draggable-box").css("height",browser_height)):($(".draggable-box").css("width",$("body").width()),$(".draggable-box").css("height",browser_height))}),setHotKey=function(){if($("body").prepend('<div class="draggable-box"></div>'),browser_width<992?($(".draggable-box").css("width",browser_width),$(".draggable-box").css("height",browser_height)):($(".draggable-box").css("width",$("body").width()),$(".draggable-box").css("height",browser_height)),$(".draggable-block").remove(),$("#test-key").html("回主頁"),isMobile.Android()){$(".bc_box").draggable({containment:".draggable-box",distance:25,scroll:!1,zIndex:5500});var o,t;t=!1,$("#test-key").bind("touchstart",function(){o=setTimeout(function(){t=!0},200)}).bind("touchend",function(){if(!t){var a=JSON.parse(Cookies.get(commonTools.storage.main))||{};window.location="http://"+WEB_URL+"/Shortcut-menu/transform?user_info="+encodeURIComponent(JSON.stringify(a))}t=!1,clearTimeout(o)})}else $("#test-key").click(function(){var o=JSON.parse(Cookies.get(commonTools.storage.main))||{};window.location="http://"+WEB_URL+"/Shortcut-menu/transform?user_info="+encodeURIComponent(JSON.stringify(o))}),$(".bc_box").draggable({containment:".draggable-box",distance:25,scroll:!1,zIndex:5500})},listenScroll=function(o){$(".page-content").scroll(function(){var a=$("#branch-cooperative .toolbar").height(),e=$("#branch-cooperative .navbar").height(),s=$("#branch-cooperative .subnavbar").height();o-$(this).scrollTop()+a+e+s-$(window).height()<=10?($(".page-content").unbind("scroll"),t&&(t=!1,getNestData())):t=!0})},closeLeftPopup=function(){$(".popup.shop-menu").addClass("modal-out",function(){$(".popup.shop-menu").removeClass("modal-in",function(){$(".popup.shop-menu").removeClass("modal-out")})}),$(".popup-overlay.modal-overlay-visible").remove(),$(document).unbind("mouseup")},Lazy=function(){0==$(".lazy").length?($(".lazy_indicator").remove(),$(".lazy_overlay").remove()):$(".lazy").Lazy({bind:"event",delay:0,onFinishedAll:function(){if(listenScroll($(".get_cate").height()),Cookies.get("offset")){var o=JSON.parse(Cookies.get("offset"));$(".page-content").animate({scrollTop:o.top}),Cookies.remove("offset")}$(".lazy_indicator").remove(),$(".lazy_overlay").remove(),t=!0},afterLoad:function(o){},onError:function(o){o.prop("src","../app/image/imgDefault.png")}})},swiper=function(){var o=$(".subnavbar .swiper_num").length;new Swiper(".blog-cate.swiper-container",{spaceBetween:0,slidesPerView:o})},getNestData=function(){showIndicator(),$(".page-content").unbind("scroll");var o=Cookies.get("longitude"),t=Cookies.get("latitude"),a=$("#token").prop("content"),e=$(".branch-list-container").data("cate"),s=Cookies.get("distance"),n=$(".start_id").last().data("id");$.ajax({dataType:"json",type:"POST",url:"/pm/branch-cooperative",data:{_token:a,cate:e,distance:s,sd_lng:o,sd_lat:t,queryamount:20,startid:n},beforeSend:function(o){o.setRequestHeader("X-CSRF-TOKEN",$("#token").attr("content"))},success:function(a){a.length>0&&(appendToList(a,o,t),setFavoriteImage(),Lazy(),$(".goToBranch").on("click",function(){$(".goToBranch").unbind("click"),showIndicator(),Cookies.remove("offset");var o=$(this).parents(".start_id"),t=o.data("id"),a={top:o.position().top,href:location.href,leng:o.index()+1,amount:20*Math.ceil((o.index()+1)/20)};Cookies.set("offset",JSON.stringify(a)),location.href="/pm/branch-info?sd_id="+t})),hideIndicator()},error:function(o){hideIndicator()}})},appendToList=function(o,t,a){if(0==listtype)for(e=0;e<o.length;e++){s='<li class="swipeout animated fadeIn start_id" data-id="'+o[e].sd_id+'"><div class="swipeout-content"><div class="item-content no-padding"><div class="blog-list">';1==o[e].sd_havebind&&(s+='<div class="authenticate_icon goToBranch"><img alt="authenticate.png" class="lazy" data-src="/app/image/authenticate.png"/></div>'),s+='<div class="image goToBranch"><a href="javascript:void(0)">',null!=(n=o[e].sd_shopphotopath)&&"/"==n.substr(0,1)&&(n=n.substr(1)),""!=o[e].sd_shopphotopath&&null!=o[e].sd_shopphotopath?s=s+'<img alt="'+n+'" class="lazy" data-src="'+stringObj.text.branch_img_path+n+'"/>':s+='<img alt="imgDefault.png" class="lazy" data-src="/app/image/imgDefault.png"/>',s=s+'</a></div><div class="col-10 favorite favorite-'+o[e].sd_id+'" onclick="addFavorite(\''+o[e].sd_id+"', '"+o[e].star_sd_shopphotopath+"', '"+o[e].sd_shopname+"', '"+o[e].sd_shopaddress+"', '"+o[e].sd_shoptel+'\', \'\',\'2\')"><img class="lazy" data-src="/app/image/unsubscribe.png" /></div><div class="text goToBranch"><h4 class="title mt-5 mb-0"><a href="javascript:void(0)">'+o[e].sd_shopname+'</a></h4><div class="row no-gutter info"><div class="col-100"><p class="row no-gutter"><span class="col-100 createdate"><span style="color:aqua;">距'+o[e].dis+' km</span><span class="note"> 地址 :</span>'+o[e].sd_shopaddress+"</span></p></div></div></div></div></div></div></li>",$(".branch-list-container").append(s)}else if(2==listtype)for(var e=0;e<o.length;e++){var s='<div class="branch-item animated zoomIn start_id" data-id="'+o[e].sd_id+'" style="background:rgba(100%,100%,100%,.7);"><div class="image listtype2 goToBranch">';1==o[e].sd_havebind&&(s+='<div class="authenticate_icon goToBranch"><img alt="authenticate.png" src="/app/image/authenticate.png"/></div>');var n=o[e].sd_shopphotopath;null!=n&&"/"==n.substr(0,1)&&(n=n.substr(1)),""!=o[e].sd_shopphotopath&&null!=o[e].sd_shopphotopath?s=s+'<img alt="'+n+'" class="lazy" data-src="'+stringObj.text.branch_img_path+n+'"/>':s+='<img alt="imgDefault.png" class="lazy" data-src="/app/image/imgDefault.png"/>',s=s+'</div><div class="text"><div class="title goToBranch"><span>'+o[e].sd_shopname+'</span></div><div class="row no-gutter"><div class="col-100 goToBranch"><p class="row no-gutter"><span class="col-90"><span style="color:aqua;">距'+o[e].dis+' km</span><span class="note"> 地址 :</span>'+o[e].sd_shopaddress+'</span></p></div><div class="col-40 favorite favorite-'+o[e].sd_id+'" onclick="addFavorite(\''+o[e].sd_id+"', '"+o[e].star_sd_shopphotopath+"', '"+o[e].sd_shopname+"', '"+o[e].sd_shopaddress+"', '"+o[e].sd_shoptel+"', '','2')\"><img class=\"lazy\" data-src=\"/app/image/unsubscribe.png\" /></div></div></div></div>",$(".row.branch-block").append(s)}},sortByDistance=function(o,t){return function(a,e){return parseFloat(a[o])>parseFloat(e[o])&&1===t?1:parseFloat(a[o])<parseFloat(e[o])&&-1===t?1:parseFloat(a[o])==parseFloat(e[o])?0:-1}},setFavoriteImage=function(){var o=commonTools._dataStorage(commonTools.storage.favorite);if(o)for(var t in o.branchList)$(".favorite-"+o.branchList[t].ubm_objectid).html('<img class="lazy" data-src="../app/image/subscribe.png" />')}});